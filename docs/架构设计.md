# Adaptive-Agent-MCP æ¶æ„è®¾è®¡æ–‡æ¡£

> æ·±å…¥è§£æç³»ç»Ÿçš„è®¾è®¡ç†å¿µã€æŠ€æœ¯å®ç°å’Œæ¶æ„å†³ç­–

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [æŠ€æœ¯å†³ç­–](#æŠ€æœ¯å†³ç­–)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
8. [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## è®¾è®¡ç†å¿µ

### æ ¸å¿ƒé—®é¢˜

AI Agent é¢ä¸´çš„ä¸‰å¤§è®°å¿†æŒ‘æˆ˜ï¼š

1. **ä¸Šä¸‹æ–‡çª—å£é™åˆ¶**
   - å³ä½¿ 200K token ä¹Ÿæ— æ³•æ‰¿è½½é•¿æœŸé¡¹ç›®çš„æ‰€æœ‰å†å²
   - æ¯æ¬¡å¯¹è¯éƒ½é‡æ–°åŠ è½½æ‰€æœ‰å†å²æ—¢æµªè´¹åˆä½æ•ˆ

2. **æ—¶é—´é”šç‚¹ç¼ºå¤±**
   - Agent çš„è®­ç»ƒæ•°æ®æ˜¯é™æ€çš„
   - æ— æ³•å‡†ç¡®çŸ¥é“"ç°åœ¨"æ˜¯ä»€ä¹ˆæ—¶å€™
   - å®¹æ˜“äº§ç”Ÿæ—¶é—´å¹»è§‰

3. **çŸ¥è¯†å†²çª**
   - ç”¨æˆ·éœ€æ±‚ä¼šå˜åŒ–
   - æ—§çš„æŒ‡ä»¤å¯èƒ½ä¸æ–°çš„æŒ‡ä»¤å†²çª
   - éœ€è¦ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

### è®¾è®¡åŸåˆ™

#### 1. åˆ†å¸ƒå¼å­˜å‚¨ (Distributed Storage)

```
ä¼ ç»Ÿæ–¹å¼ (All-in-Context):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt (200K tokens)           â”‚
â”‚  â”œâ”€ System Prompt               â”‚
â”‚  â”œâ”€ All History (150K tokens)   â”‚  âŒ æµªè´¹
â”‚  â””â”€ User Query                  â”‚  âŒ æ…¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æˆ‘ä»¬çš„æ–¹å¼ (On-Demand):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt (20K tokens)            â”‚
â”‚  â”œâ”€ System Prompt               â”‚
â”‚  â”œâ”€ Relevant Context (10K)      â”‚  âœ… ç²¾å‡†
â”‚  â””â”€ User Query                  â”‚  âœ… å¿«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ MCP Tools
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  External Memory (Unlimited)    â”‚
â”‚  â”œâ”€ Knowledge Graph             â”‚
â”‚  â”œâ”€ Daily Logs (Years)          â”‚
â”‚  â””â”€ Implicit Knowledge          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æŒ‰éœ€åŠ è½½ (Lazy Loading)

**ç­–ç•¥**:
- **Always Load**: éšæ€§çŸ¥è¯† (MEMORY.md) - é€šå¸¸ < 2KB
- **Proximity Load**: æœ€è¿‘ 1-2 å¤©çš„æ—¥å¿— - çº¦ 5-10KB
- **On-Demand Load**: å…¶ä»–å†å² - ä»…åœ¨éœ€è¦æ—¶åŠ è½½

#### 3. æ—¶é—´æƒå¨ (Time Authority)

**é—®é¢˜**: Agent ä¸çŸ¥é“"ç°åœ¨"

**è§£å†³æ–¹æ¡ˆ**: MCP æ˜¯æ—¶é—´çš„å”¯ä¸€çœŸç†æ¥æº

```python
# âŒ Agent ä¸èƒ½è¿™æ ·åš
def agent_write_log():
    date = "2026-02-05"  # å¹»è§‰ï¼
    write_to_file(f"{date}.md", content)

# âœ… æ­£ç¡®çš„æ–¹å¼
def mcp_write_log(content):
    date = datetime.now()  # çœŸå®çš„ç³»ç»Ÿæ—¶é—´
    write_to_file(f"{date}.md", content)
```

#### 4. çŸ¥è¯†æ¼”åŒ– (Knowledge Evolution)

**é—®é¢˜**: å¦‚ä½•å¤„ç†çŸ¥è¯†æ›´æ–°ï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| ç›´æ¥è¦†ç›– | ç®€å• | ä¸¢å¤±å†å²ï¼Œæ— æ³•å›æº¯ |
| ç‰ˆæœ¬æ§åˆ¶ (Git) | å®Œæ•´å†å² | å¤æ‚ï¼Œéš¾ä»¥æŸ¥è¯¢ |
| **Supersede æœºåˆ¶** | **ä¿ç•™å†å² + æ˜“æŸ¥è¯¢** | **éœ€è¦é¢å¤–å­—æ®µ** |

**æˆ‘ä»¬çš„é€‰æ‹©**: Supersede æœºåˆ¶

```json
{
  "id": "fact-001",
  "fact": "ä½¿ç”¨ MySQL",
  "status": "superseded",
  "supersededBy": "fact-002"
}
{
  "id": "fact-002",
  "fact": "ä½¿ç”¨ PostgreSQL",
  "status": "active",
  "supersedes_id": "fact-001"
}
```

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AI Agent                             â”‚
â”‚  (Claude, GPT-4, etc.)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ MCP Protocol (JSON-RPC)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Adaptive-Agent-MCP Server                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tool Layer (7 Tools)                                â”‚   â”‚
â”‚  â”‚  â”œâ”€ initialize_session                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ query_memory_headers                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ read_memory_content                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ search_memory_content                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ append_daily_log                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ get_period_context                               â”‚   â”‚
â”‚  â”‚  â””â”€ archive_period                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Core Components                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ Indexer (memory_index.json)                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ SearchEngine (ripgrep wrapper)                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ StorageValidation (file operations)             â”‚   â”‚
â”‚  â”‚  â””â”€ Config (settings management)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ File System I/O
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Storage Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Layer 3      â”‚ Layer 2      â”‚ Layer 1              â”‚     â”‚
â”‚  â”‚ MEMORY.md    â”‚ Daily Logs   â”‚ Knowledge Graph      â”‚     â”‚
â”‚  â”‚ (Always On)  â”‚ (On-Demand)  â”‚ (Indexed)            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚è®¾è®¡

#### Layer 1: Tool Layer (å·¥å…·å±‚)

**èŒè´£**: æš´éœ²ç»™ Agent çš„ MCP å·¥å…·æ¥å£

**ç‰¹ç‚¹**:
- ä½¿ç”¨ FastMCP æ¡†æ¶ç®€åŒ–å¼€å‘
- æ¯ä¸ªå·¥å…·éƒ½æœ‰è¯¦ç»†çš„ docstring (Agent å¯è§)
- å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

#### Layer 2: Core Components (æ ¸å¿ƒç»„ä»¶å±‚)

**èŒè´£**: å®ç°ä¸šåŠ¡é€»è¾‘

**ç»„ä»¶**:
- `Indexer`: ç´¢å¼•ç®¡ç†
- `SearchEngine`: å…¨æ–‡æœç´¢
- `StorageValidation`: æ–‡ä»¶æ“ä½œ
- `Config`: é…ç½®ç®¡ç†

#### Layer 3: Storage Layer (å­˜å‚¨å±‚)

**èŒè´£**: æŒä¹…åŒ–æ•°æ®

**ç‰¹ç‚¹**:
- çº¯æ–‡æœ¬æ ¼å¼ (Markdown + JSON)
- äººç±»å¯è¯»
- æ˜“äºå¤‡ä»½å’Œç‰ˆæœ¬æ§åˆ¶

---

## æ ¸å¿ƒç»„ä»¶

### 1. Indexer (ç´¢å¼•å™¨)

**ç›®çš„**: åŠ é€Ÿ YAML å¤´çš„æŸ¥è¯¢

**å®ç°**:

```python
class Indexer:
    def build_index(self) -> Dict[str, Any]:
        """æ‰«ææ‰€æœ‰ .md æ–‡ä»¶ï¼Œæå– YAML å¤´"""
        index_data = {}
        
        for file in all_markdown_files:
            # åªè¯»å–å‰ 1000 å­—èŠ‚ (è¶³å¤ŸåŒ…å« YAML å¤´)
            header = file.read(1000)
            yaml_data = parse_yaml(header)
            
            index_data[file.path] = {
                "date": yaml_data.get("date"),
                "tags": yaml_data.get("tags"),
                "summary": yaml_data.get("summary")
            }
        
        # ä¿å­˜åˆ° .index/memory_index.json
        save_json(index_data)
        return index_data
```

**æ€§èƒ½**:
- æ„å»ºç´¢å¼•: O(n) - n ä¸ºæ–‡ä»¶æ•°é‡
- æŸ¥è¯¢ç´¢å¼•: O(1) - ç›´æ¥è¯»å– JSON

**æ›´æ–°ç­–ç•¥**:
- æ¯æ¬¡ `append_daily_log` åè‡ªåŠ¨é‡å»º
- é¦–æ¬¡å¯åŠ¨æ—¶æ„å»º
- å¯æ‰‹åŠ¨è§¦å‘é‡å»º

### 2. SearchEngine (æœç´¢å¼•æ“)

**ç›®çš„**: æä¾›å…¨æ–‡æœç´¢èƒ½åŠ›

**å®ç°**:

```python
class SearchEngine:
    def search(self, query: str, regex: bool = False) -> str:
        """ä½¿ç”¨ ripgrep è¿›è¡Œå…¨æ–‡æœç´¢"""
        cmd = [
            "rg",
            "--line-number",      # æ˜¾ç¤ºè¡Œå·
            "--context=2",        # æ˜¾ç¤ºä¸Šä¸‹æ–‡
            "--max-count=20",     # é™åˆ¶ç»“æœæ•°
            "--ignore-case",      # å¿½ç•¥å¤§å°å†™
            query,
            str(storage_path)
        ]
        
        result = subprocess.run(cmd, capture_output=True)
        return result.stdout
```

**ä¸ºä»€ä¹ˆé€‰æ‹© ripgrep**:
- é€Ÿåº¦æå¿« (æ¯” grep å¿« 10-100 å€)
- è‡ªåŠ¨å¿½ç•¥ .git ç­‰ç›®å½•
- æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼
- è·¨å¹³å°

### 3. StorageValidation (å­˜å‚¨éªŒè¯)

**ç›®çš„**: ç®¡ç†æ–‡ä»¶ç³»ç»Ÿæ“ä½œ

**æ ¸å¿ƒæ–¹æ³•**:

```python
class StorageValidation:
    @staticmethod
    def get_daily_log_path(date: datetime) -> Path:
        """
        ç”Ÿæˆæ—¥å¿—æ–‡ä»¶è·¯å¾„
        æ ¼å¼: memory/YYYY/MM_month/week_WW/YYYY-MM-DD.md
        """
        year = date.strftime("%Y")
        month = date.strftime("%m_%B").lower()
        week = f"week_{date.isocalendar()[1]:02d}"
        filename = date.strftime("%Y-%m-%d.md")
        
        path = storage_path / "memory" / year / month / week
        path.mkdir(parents=True, exist_ok=True)
        
        return path / filename
```

**è®¾è®¡è€ƒè™‘**:
- è‡ªåŠ¨åˆ›å»ºç›®å½•
- è·¯å¾„è§„èŒƒåŒ– (ç»Ÿä¸€ä½¿ç”¨ `/`)
- å®‰å…¨æ£€æŸ¥ (é˜²æ­¢è·¯å¾„éå†æ”»å‡»)

### 4. Config (é…ç½®ç®¡ç†)

**ç›®çš„**: ç»Ÿä¸€ç®¡ç†é…ç½®

**å®ç°**:

```python
class Settings(BaseSettings):
    storage_path: Path = Path.home() / ".adaptive-agent" / "memory"
    ripgrep_path: Optional[str] = None
    
    class Config:
        env_prefix = "ADAPTIVE_AGENT_"

# æ”¯æŒä¸‰ç§é…ç½®æ–¹å¼
# 1. å‘½ä»¤è¡Œå‚æ•°: --storage-path ./memory
# 2. ç¯å¢ƒå˜é‡: ADAPTIVE_AGENT_STORAGE_PATH=./memory
# 3. é»˜è®¤å€¼: ~/.adaptive-agent/memory
```

---

## æ•°æ®æµ

### åœºæ™¯ 1: ä¼šè¯åˆå§‹åŒ–

```
User: "ä½ å¥½"
  â”‚
  â–¼
Agent: æ£€æµ‹åˆ° initialize_session å·¥å…·
  â”‚
  â–¼
MCP: initialize_session()
  â”‚
  â”œâ”€ è¯»å– MEMORY.md
  â”œâ”€ è·å–æœ€è¿‘ 2 å¤©çš„æ—¥å¿—
  â”œâ”€ è¯»å–æœ¬å‘¨çš„ YAML å¤´
  â””â”€ ç»„åˆæˆ Markdown å—
  â”‚
  â–¼
Agent: æ¥æ”¶ä¸Šä¸‹æ–‡ï¼Œå›å¤ç”¨æˆ·
```

### åœºæ™¯ 2: å†™å…¥æ—¥å¿—

```
User: "æˆ‘å®Œæˆäº†ç™»å½•åŠŸèƒ½"
  â”‚
  â–¼
Agent: append_daily_log(content="å®Œæˆç™»å½•åŠŸèƒ½", tags=["dev"])
  â”‚
  â–¼
MCP: append_daily_log()
  â”‚
  â”œâ”€ è·å–å½“å‰æ—¶é—´: 2026-02-05
  â”œâ”€ è®¡ç®—è·¯å¾„: memory/2026/02_february/week_06/2026-02-05.md
  â”œâ”€ åˆ›å»º/è¿½åŠ å†…å®¹
  â”œâ”€ è§¦å‘ç´¢å¼•é‡å»º
  â””â”€ è¿”å›æˆåŠŸæ¶ˆæ¯
  â”‚
  â–¼
Agent: "å·²è®°å½• âœ…"
```

### åœºæ™¯ 3: æŸ¥è¯¢å†å²

```
User: "æˆ‘ä»¬è®¨è®ºè¿‡æ•°æ®åº“è®¾è®¡å—ï¼Ÿ"
  â”‚
  â–¼
Agent: query_memory_headers(tags=["database"])
  â”‚
  â–¼
MCP: query_memory_headers()
  â”‚
  â”œâ”€ è¯»å– memory_index.json
  â”œâ”€ è¿‡æ»¤ tags åŒ…å« "database" çš„æ¡ç›®
  â””â”€ è¿”å›æ–‡ä»¶è·¯å¾„å’Œæ‘˜è¦åˆ—è¡¨
  â”‚
  â–¼
Agent: åˆ†ææ‘˜è¦ï¼Œå‘ç° 2026-01-28 ç›¸å…³
  â”‚
  â–¼
Agent: read_memory_content(["memory/.../2026-01-28.md"])
  â”‚
  â–¼
MCP: read_memory_content()
  â”‚
  â”œâ”€ å®‰å…¨æ£€æŸ¥è·¯å¾„
  â”œâ”€ è¯»å–æ–‡ä»¶å†…å®¹
  â””â”€ è¿”å›å®Œæ•´ Markdown
  â”‚
  â–¼
Agent: "æ˜¯çš„ï¼Œ1æœˆ28æ—¥æˆ‘ä»¬è®¨è®ºäº†..."
```

---

## æŠ€æœ¯å†³ç­–

### å†³ç­– 1: ä¸ºä»€ä¹ˆä½¿ç”¨ Markdown + YAMLï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
1. çº¯ JSON
2. SQLite æ•°æ®åº“
3. Markdown + YAML (é€‰æ‹©)

**å¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| çº¯ JSON | ç»“æ„åŒ–ï¼Œæ˜“è§£æ | ä¸é€‚åˆé•¿æ–‡æœ¬ï¼Œäººç±»éš¾è¯» |
| SQLite | æŸ¥è¯¢å¿«ï¼Œäº‹åŠ¡æ”¯æŒ | äºŒè¿›åˆ¶æ ¼å¼ï¼Œéš¾ä»¥ç‰ˆæœ¬æ§åˆ¶ |
| **Markdown + YAML** | **äººç±»å¯è¯»ï¼ŒGit å‹å¥½ï¼Œçµæ´»** | **éœ€è¦è§£æ YAML** |

**æœ€ç»ˆé€‰æ‹©**: Markdown + YAML

**ç†ç”±**:
- ç”¨æˆ·å¯ä»¥ç›´æ¥ç”¨ç¼–è¾‘å™¨æŸ¥çœ‹/ç¼–è¾‘
- å¯ä»¥ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶
- æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼ (ä»£ç å—ã€åˆ—è¡¨ç­‰)
- YAML å¤´æä¾›ç»“æ„åŒ–å…ƒæ•°æ®

### å†³ç­– 2: ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ç¼“å­˜ï¼Ÿ

**é—®é¢˜**: éå† 1000 ä¸ªæ–‡ä»¶è¯»å– YAML å¤´éœ€è¦ 5-10 ç§’

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | æŸ¥è¯¢é€Ÿåº¦ | å®ç°å¤æ‚åº¦ | ä¸€è‡´æ€§ |
|------|----------|------------|--------|
| å®æ—¶æ‰«æ | æ…¢ (5-10s) | ä½ | å®Œç¾ |
| **JSON ç´¢å¼•** | **å¿« (< 100ms)** | **ä¸­** | **æœ€ç»ˆä¸€è‡´** |
| æ•°æ®åº“ç´¢å¼• | å¿« | é«˜ | å®Œç¾ |

**æœ€ç»ˆé€‰æ‹©**: JSON ç´¢å¼•

**ç†ç”±**:
- æ€§èƒ½æå‡ 50-100 å€
- å®ç°ç®€å• (ä¸€ä¸ª JSON æ–‡ä»¶)
- æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å— (æ¯æ¬¡å†™å…¥åæ›´æ–°)

### å†³ç­– 3: ä¸ºä»€ä¹ˆä½¿ç”¨ Supersede è€Œä¸æ˜¯åˆ é™¤ï¼Ÿ

**é—®é¢˜**: ç”¨æˆ·éœ€æ±‚å˜åŒ–ï¼Œå¦‚ä½•å¤„ç†æ—§çŸ¥è¯†ï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| ç›´æ¥åˆ é™¤ | ç®€å• | ä¸¢å¤±å†å² |
| Git ç‰ˆæœ¬æ§åˆ¶ | å®Œæ•´å†å² | æŸ¥è¯¢å¤æ‚ |
| **Supersede æ ‡è®°** | **ä¿ç•™å†å² + æ˜“æŸ¥è¯¢** | **éœ€è¦é¢å¤–å­—æ®µ** |

**æœ€ç»ˆé€‰æ‹©**: Supersede æ ‡è®°

**ç†ç”±**:
- å¯è¿½æº¯å†³ç­–å†å²
- æŸ¥è¯¢æ—¶åªè¿”å› active çŠ¶æ€çš„äº‹å®
- æ”¯æŒå›æ»š (é‡æ–°æ¿€æ´»æ—§äº‹å®)

### å†³ç­– 4: ä¸ºä»€ä¹ˆé€‰æ‹© FastMCPï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
1. åŸç”Ÿ MCP SDK
2. FastMCP (é€‰æ‹©)

**å¯¹æ¯”**:

```python
# åŸç”Ÿ MCP SDK (å¤æ‚)
from mcp.server import Server
from mcp.types import Tool, TextContent

server = Server("my-server")

@server.list_tools()
async def list_tools():
    return [
        Tool(
            name="my_tool",
            description="...",
            inputSchema={...}
        )
    ]

@server.call_tool()
async def call_tool(name: str, arguments: dict):
    if name == "my_tool":
        # å¤„ç†é€»è¾‘
        return [TextContent(text="result")]

# FastMCP (ç®€æ´)
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("my-server")

@mcp.tool()
def my_tool(param: str) -> str:
    """å·¥å…·æè¿°"""
    # å¤„ç†é€»è¾‘
    return "result"
```

**æœ€ç»ˆé€‰æ‹©**: FastMCP

**ç†ç”±**:
- ä»£ç é‡å‡å°‘ 50%
- è‡ªåŠ¨ç”Ÿæˆ JSON Schema
- ç±»å‹å®‰å…¨ (åŸºäº Python ç±»å‹æç¤º)

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ç¼“å­˜

**ä¼˜åŒ–å‰**: æ¯æ¬¡æŸ¥è¯¢æ‰«ææ‰€æœ‰æ–‡ä»¶
```python
def query_headers(tags):
    results = []
    for file in all_files:  # O(n)
        yaml = parse_yaml(file.read())  # I/O å¯†é›†
        if matches(yaml, tags):
            results.append(yaml)
    return results
```

**ä¼˜åŒ–å**: è¯»å– JSON ç´¢å¼•
```python
def query_headers(tags):
    index = json.load("memory_index.json")  # O(1)
    results = [
        item for item in index.values()
        if matches(item, tags)
    ]
    return results
```

**æ€§èƒ½æå‡**: 50-100 å€

### 2. éƒ¨åˆ†è¯»å–

**ä¼˜åŒ–**: åªè¯»å–æ–‡ä»¶çš„å‰ 1000 å­—èŠ‚æ¥æå– YAML å¤´

```python
# âŒ è¯»å–æ•´ä¸ªæ–‡ä»¶
content = file.read()  # å¯èƒ½ 100KB
yaml = extract_yaml(content)

# âœ… åªè¯»å–å¤´éƒ¨
header = file.read(1000)  # åªè¯» 1KB
yaml = extract_yaml(header)
```

**æ€§èƒ½æå‡**: 10-100 å€ (å–å†³äºæ–‡ä»¶å¤§å°)

### 3. è¾“å‡ºæˆªæ–­

**ä¼˜åŒ–**: é™åˆ¶æœç´¢ç»“æœçš„é•¿åº¦

```python
def search(query):
    result = ripgrep_search(query)
    
    # æˆªæ–­è¿‡é•¿çš„è¾“å‡º
    if len(result) > 8000:
        result = result[:8000] + "\n...[Truncated]..."
    
    return result
```

**å¥½å¤„**: èŠ‚çœ tokenï¼ŒåŠ å¿«ä¼ è¾“

---

## å®‰å…¨è€ƒè™‘

### 1. è·¯å¾„éå†é˜²æŠ¤

**é—®é¢˜**: æ¶æ„è·¯å¾„å¯èƒ½è®¿é—®ç³»ç»Ÿæ–‡ä»¶

```python
# âŒ å±é™©
def read_file(path: str):
    return open(path).read()

# æ”»å‡»ç¤ºä¾‹
read_file("../../../etc/passwd")
```

**é˜²æŠ¤**:

```python
def read_file(path: str):
    path = Path(path).resolve()
    storage = config.storage_path.resolve()
    
    # æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å­˜å‚¨ç›®å½•å†…
    try:
        path.relative_to(storage)
    except ValueError:
        raise SecurityError("Access denied")
    
    return path.read_text()
```

### 2. å‘½ä»¤æ³¨å…¥é˜²æŠ¤

**é—®é¢˜**: ç”¨æˆ·è¾“å…¥å¯èƒ½åŒ…å«æ¶æ„å‘½ä»¤

```python
# âŒ å±é™©
def search(query: str):
    os.system(f"rg {query}")  # å‘½ä»¤æ³¨å…¥é£é™©

# æ”»å‡»ç¤ºä¾‹
search("test; rm -rf /")
```

**é˜²æŠ¤**:

```python
def search(query: str):
    # ä½¿ç”¨å‚æ•°åˆ—è¡¨ï¼Œä¸ä½¿ç”¨ shell
    subprocess.run(
        ["rg", query, str(storage_path)],
        shell=False,  # å…³é”®ï¼
        capture_output=True
    )
```

### 3. è¾“å…¥éªŒè¯

**å®ç°**:

```python
def append_daily_log(
    content: Optional[str] = None,
    tags: Optional[List[str]] = None
):
    # éªŒè¯ tags
    if tags:
        for tag in tags:
            if not re.match(r'^[a-z0-9-]+$', tag):
                raise ValueError(f"Invalid tag: {tag}")
    
    # éªŒè¯ content é•¿åº¦
    if content and len(content) > 100000:
        raise ValueError("Content too long")
```

---

## æ‰©å±•æ€§

### 1. æ·»åŠ æ–°å·¥å…·

**æ­¥éª¤**:

1. åœ¨ `src/tools/` åˆ›å»ºæ–°æ–‡ä»¶
2. ä½¿ç”¨ `@mcp.tool()` è£…é¥°å™¨
3. åœ¨ `server.py` ä¸­å¯¼å…¥

**ç¤ºä¾‹**:

```python
# src/tools/export.py
from server import mcp

@mcp.tool()
def export_to_pdf(date_range: str) -> str:
    """å¯¼å‡ºæŒ‡å®šæ—¥æœŸèŒƒå›´çš„æ—¥å¿—ä¸º PDF"""
    # å®ç°é€»è¾‘
    return "Exported to memory_export.pdf"
```

### 2. æ”¯æŒæ–°çš„å­˜å‚¨åç«¯

**å½“å‰**: æ–‡ä»¶ç³»ç»Ÿ

**æœªæ¥å¯èƒ½**:
- S3 / äº‘å­˜å‚¨
- æ•°æ®åº“ (PostgreSQL)
- Git ä»“åº“

**å®ç°æ–¹å¼**: æŠ½è±¡å­˜å‚¨æ¥å£

```python
class StorageBackend(ABC):
    @abstractmethod
    def read(self, path: str) -> str:
        pass
    
    @abstractmethod
    def write(self, path: str, content: str):
        pass

class FileSystemBackend(StorageBackend):
    # å½“å‰å®ç°
    pass

class S3Backend(StorageBackend):
    # æœªæ¥å®ç°
    pass
```

### 3. å¤šè¯­è¨€æ”¯æŒ

**å½“å‰**: ä¸­æ–‡ + è‹±æ–‡æ··åˆ

**æ‰©å±•**: å®Œå…¨å›½é™…åŒ–

```python
# i18n/zh_CN.json
{
  "session_initialized": "ä¼šè¯å·²åˆå§‹åŒ–",
  "log_appended": "æ—¥å¿—å·²æ·»åŠ "
}

# i18n/en_US.json
{
  "session_initialized": "Session initialized",
  "log_appended": "Log appended"
}
```

---

## æ€»ç»“

Adaptive-Agent-MCP é€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†é«˜æ•ˆçš„ AI è®°å¿†ç³»ç»Ÿï¼š

1. **åˆ†å±‚æ¶æ„**: ä¸‰å±‚è®°å¿†æ¨¡å‹ï¼ŒæŒ‰éœ€åŠ è½½
2. **æ—¶é—´æƒå¨**: MCP æ§åˆ¶æ—¶é—´ï¼Œé˜²æ­¢å¹»è§‰
3. **ç´¢å¼•åŠ é€Ÿ**: JSON ç¼“å­˜æå‡æŸ¥è¯¢æ€§èƒ½ 50-100 å€
4. **çŸ¥è¯†æ¼”åŒ–**: Supersede æœºåˆ¶ä¿ç•™å†å²
5. **å®‰å…¨è®¾è®¡**: è·¯å¾„éªŒè¯ã€å‘½ä»¤æ³¨å…¥é˜²æŠ¤
6. **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ–°åŠŸèƒ½

è¿™ä¸ªæ¶æ„åœ¨**æ€§èƒ½**ã€**å¯ç»´æŠ¤æ€§**å’Œ**ç”¨æˆ·ä½“éªŒ**ä¹‹é—´å–å¾—äº†è‰¯å¥½çš„å¹³è¡¡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-02-05
